# heat-flow-solver 仕様書

## 1. 概要

本プログラムは、要求熱負荷に対して熱源をどの負荷率で何台運転するのが最も効率的かを算出し、最適な運転パターンを返却するシステムです。

### 1.1 目的
- 一次エネルギー消費量の最小化（本システムでは電力消費量の最小化と同義）
- 熱源機器の効率的な運転制御

### 1.2 最適化基準
- **最適化指標**: 電力消費量の最小化
- **制約条件**: 機器の負荷上限・下限、台数制約

## 2. 動作モード

### 2.1 運用モード（Production Mode）
- 与えられた熱源で負荷を処理できない場合、最大台数・最大負荷率で運転
- システムダウンを回避するためのフェイルセーフ動作

### 2.2 テストモード（Test Mode）
- 処理不可能な負荷の場合、エラーメッセージを返却
- システム設計時の検証用

## 3. 入力仕様

### 3.1 機器構成（入力①）

#### 3.1.1 ヒートポンプ
| 項目 | 型 | 説明 |
|------|-----|------|
| 台数 | int | 設置されているヒートポンプの総台数 |
| 負荷特性テーブル | float[6] | 負荷率 0%, 20%, 40%, 60%, 80%, 100% 時の消費電力 [kW] |
| 出口温度設定 | float | 冷水出口温度 [°C] |
| 負荷上限 | float | 最大負荷率 [%] (0-100) |
| 負荷下限 | float | 最小負荷率 [%] (0-100) |

**前提条件**:
- すべてのヒートポンプは同一性能とする
- 負荷上限・下限は熱量・流量ともに同一の値を使用する

**負荷特性テーブルの例**:
```
負荷率[%]: [  0,  20,  40,  60,  80, 100]
消費電力[kW]: [5.0, 8.0, 12.0, 18.0, 25.0, 35.0]
```

#### 3.1.2 冷水ポンプ
| 項目 | 型 | 説明 |
|------|-----|------|
| 台数 | int | ヒートポンプと同数 |
| 定格動力 (A) | float | 負荷率100%時の消費電力 [kW] |

**動力特性**:
```
P = A × x³
```
- P: 消費電力 [kW]
- A: 定格動力 [kW]
- x: 負荷率 (0.0 - 1.0)

### 3.2 運転条件（入力②）

| 項目 | 型 | 説明 |
|------|-----|------|
| 冷水還温度 | float | 冷水の戻り温度 [°C] |
| 冷水還流量 | float | 冷水の戻り流量 [m³/h] または [L/min] |

## 4. 出力仕様

### 4.1 正常時
```json
{
  "status": "success",
  "total_power": 45.2,
  "heat_pumps": [
    {
      "unit_id": 1,
      "load_rate": 80.0,
      "power": 25.0,
      "flow_rate": 120.0
    },
    {
      "unit_id": 2,
      "load_rate": 60.0,
      "power": 18.0,
      "flow_rate": 90.0
    }
  ],
  "pumps": [
    {
      "unit_id": 1,
      "load_rate": 0.75,
      "power": 1.5
    },
    {
      "unit_id": 2,
      "load_rate": 0.56,
      "power": 0.7
    }
  ]
}
```

### 4.2 処理不可能時（運用モード）
```json
{
  "status": "overload",
  "message": "Required load exceeds maximum capacity. Running at maximum.",
  "total_power": 150.0,
  "heat_pumps": [...],  // 全台数、最大負荷率
  "pumps": [...]
}
```

### 4.3 処理不可能時（テストモード）
```json
{
  "status": "error",
  "message": "Cannot handle the required load with given equipment.",
  "required_load": 1200.0,
  "maximum_capacity": 1000.0
}
```

## 5. 制御ロジック

### 5.1 負荷算出
冷水の熱負荷を以下の式で算出:
```
Q = m × c × Δt
```
- Q: 熱負荷 [kW]
- m: 質量流量 [kg/s]
- c: 比熱 (水: 4.186 kJ/(kg·K))
- Δt: 温度差 [K] = 冷水還温度 - 出口温度設定

### 5.2 最適化アルゴリズム

#### ステップ1: パターン生成
運転台数 n (1 ≤ n ≤ 総台数) ごとにすべての負荷配分パターンを生成

#### ステップ2: 各パターンの評価
各パターンについて以下を計算:

1. **ヒートポンプ流量の決定**
   ```
   各HPの流量 = 割り当て負荷 / (c × (還温度 - 出口温度))
   ```

2. **ヒートポンプ消費電力の算出**
   - 負荷特性テーブルから線形補間により算出

3. **ポンプ負荷率の算出**
   ```
   ポンプ負荷率 = HP流量 / 定格流量
   ```

4. **ポンプ消費電力の算出**
   ```
   ポンプ動力 = A × (負荷率)³
   ```

5. **総消費電力の算出**
   ```
   総電力 = Σ(HP電力) + Σ(ポンプ電力)
   ```

#### ステップ3: 制約チェック
以下の制約を満たさないパターンは除外:
- ヒートポンプ負荷率: 下限 ≤ 負荷率 ≤ 上限
- ポンプ負荷率: 0 ≤ 負荷率 ≤ 1.0
- 流量: 物理的に実現可能な範囲

#### ステップ4: 最適解の選択
制約を満たすパターンの中から、総消費電力が最小となるパターンを最適解として選択

### 5.3 処理フロー図
```
[入力] 機器構成 + 運転条件
    ↓
[計算] 要求熱負荷 Q
    ↓
[生成] 運転台数パターン (1台, 2台, ..., n台)
    ↓
[各パターンで実行]
    ├─ 負荷配分の決定
    ├─ 流量の算出
    ├─ 消費電力の算出
    ├─ 制約チェック → NG なら除外
    └─ OK なら候補に追加
    ↓
[選択] 消費電力最小のパターン
    ↓
[出力] 最適運転パターン
```

## 6. 実装上の注意点

### 6.1 数値精度
- 浮動小数点演算の誤差に注意
- 温度・流量の単位系を統一すること

### 6.2 エッジケース
- 負荷が極端に小さい場合（下限制約に抵触）
- 負荷が極端に大きい場合（上限制約に抵触）
- 温度差がゼロまたは負の場合

### 6.3 性能最適化
- 明らかに不適切なパターンの早期除外
- 対称性を利用した探索空間の削減

## 7. 今後の拡張可能性

### 7.1 機能拡張
- 複数種類のヒートポンプへの対応
- 時系列データに基づく予測制御
- 機器の劣化・故障を考慮した運転最適化

### 7.2 最適化手法
- 遺伝的アルゴリズムの導入
- 機械学習による負荷予測との連携

## 8. 参考資料

### 8.1 関連する物理式
- 熱量: Q = m × c × Δt
- ポンプ動力: P ∝ Q³ (相似則)
- COP (成績係数): COP = Q / W

### 8.2 用語集
| 用語 | 説明 |
|------|------|
| ヒートポンプ | 熱を移動させる機械（冷凍機） |
| 負荷率 | 定格能力に対する実際の出力の比率 |
| COP | Coefficient of Performance（成績係数） |
| 一次エネルギー | 石油・ガス・電力など、変換されていないエネルギー |

---

**バージョン**: 1.0  
**最終更新**: 2024-12-07  
**作成者**: kneco
